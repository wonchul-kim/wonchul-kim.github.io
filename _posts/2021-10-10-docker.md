---
layout: post
title: Docker
category: mlops
tag: docker
---




## Issues

* docker에서 해당 서버의 gpu를 사용하고자 할 때는 서버에서 

```
# Add the package repositories
distribution=$(. /etc/os-release;echo $ID$VERSION_ID)
curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add -
curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.list

sudo apt-get update && sudo apt-get install -y nvidia-container-toolkit
sudo systemctl restart docker
```

docker 실행할 때에는 `run ... --gpus all ...`을 붙인다. 


* 학습을 할 때에 shared memory가 부족하다고 할 수 있다. 

docker 실행할 때, `run ... --shm-size 4G ...`로 설정할 수 있다. 


* ImportError: libGL.so.1: cannot open shared object file: No such file or directory

opencv를 docker image에서 활용하기 위해서는 기본 base의 python env에 opencv-python을 설치하거나
이미 opencv가 설치되어 있는 환경의 docker를 base로 하여 사용할 수 있다. 

이 때, 위와 같은 error가 나타날 수 있는데 이는 다음과 같이 해결이 가능하다. 

```
RUN apt-get update RUN apt-get -y install libgl1-mesa-glx
```


## docker에서 GPU 사용하기

`nvidia-docker`와 `docker`는 사용?목적?애 았어서는 과정에 큰 차이가 없다. 일반적으로 `docker container`내에서는 HOST OS가 사용하는 GPU를 사용할 수가 없는데, 이를 사용할 수 있도록 설정을 지원해주는 `docker`가 `nvidia-docker`라고 생각하면 된다. 

이를 위해서 설치해야하는 것이 `nvidia-docker2`로 nvidia container toolkit을 통해서 nvidia의 ngc의 컨테이너들을 nvidia-docker를 통하여 GPU를 할당하여 설정할 수가 있다.

#### nvidia-docker 설치
* key 및 저장소 추가
```
distribution=$(. /etc/os-release;echo $ID$VERSION_ID) \
   && curl -s -L https://nvidia.github.io/nvidia-docker/gpgkey | sudo apt-key add - \
   && curl -s -L https://nvidia.github.io/nvidia-docker/$distribution/nvidia-docker.list | sudo tee /etc/apt/sources.list.d/nvidia-docker.list
```

* nvidia-docker2 설치
``` 
sudo apt-get update & apt-get install nvidia-docker2 -y
```

* `/etc/docker/daemon.json` 내용을 아래와 같이 수정
```
{
        "runtimes": {
                "nvidia": {
                        "path": "/usr/bin/nvidia-container-runtime",
                        "runtimeArgs": []
                }
        }
}
```
```
sudo pkill -SIGHUP dockerd
sudo systemctl restart docker
```

* 실행 방법
1. `nvidia-docker`를 사용
```
NV_GPU=0,1 nvidia-docker run -it nvcr.io/nvidia/tensorflow:20.12-tf1-py3
```

2-1. `nvidia-docker2`를 사용
```
NV_GPU=0,1 nvidia-docker run -it nvcr.io/nvidia/tensorflow:20.12-tf1-py3
```
2-2
```
docker run -it --gpus '"device=0,1,2,3"' nvcr.io/nvidia/tensorflow:20.12-tf1-py3
# 또는 
docker run -it --gpus all nvcr.io/nvidia/tensorflow:20.12-tf1-py3
```




